<!DOCTYPE html>
<html lang="pt-br">
<head>
<!-- Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Cor da barra do app -->
<meta name="theme-color" content="#00d4ff">

<!-- √çcone padr√£o -->
<link rel="icon" type="image/png" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BLUESOUND PRO</title>
    <style>
        :root {
            --primary: #00d4ff;
            --bg: #000000;
            --card: #1c1c1e;
            --accent: #007aff;
            --danger: #ff3b30;
            --ios-blur: rgba(30, 30, 30, 0.75);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: white;
            padding-bottom: 120px;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            user-select: none;
        }

        header {
            width: 100%;
            padding: 50px 20px 20px;
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .btn-main, .btn-outline, .playlist-chip, .song, .menu-item {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
        }
        
        .btn-main:active, .btn-outline:active, .playlist-chip:active, .menu-item:active {
            transform: scale(0.92);
            opacity: 0.7;
        }

        .playlist-bar {
            width: 100%;
            display: flex;
            gap: 12px;
            padding: 10px 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .playlist-bar::-webkit-scrollbar { display: none; }

        .playlist-chip {
            background: var(--card);
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .playlist-chip.active { background: white; color: black; }

        .controls-area { width: 90%; display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
        
        .btn-main {
            background: var(--accent);
            color: white;
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-weight: 600;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-row { display: flex; gap: 10px; width: 100%; }
        .btn-outline {
            flex: 1;
            background: var(--card);
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #library {
            width: 92%;
            background: var(--card);
            border-radius: 14px;
            overflow: hidden;
            margin-top: 10px;
        }

        .song {
            padding: 14px 18px;
            display: flex;
            align-items: center;
            border-bottom: 0.5px solid rgba(255,255,255,0.05);
        }
        .song:active { background: #2c2c2e; }

        #player {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-height: 85px;
            background: var(--ios-blur);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 10px 20px 30px;
            border-top: 0.5px solid rgba(255,255,255,0.1);
            display: none;
            flex-direction: column;
            z-index: 2000;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        #player.full {
            max-height: 100vh;
            height: 100vh;
            border-radius: 0;
            padding-top: 60px;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 15px 0;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #ffffff;
            margin-top: -6px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .player-btns {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            margin-top: 30px;
        }

        .play-circle {
            width: 75px;
            height: 75px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-size: 30px;
        }

        .full-only { display: none; }
        #player.full .full-only { display: flex; }
        #player.full .mini-only { display: none; }
        #player.full #cover { width: 80vw; height: 80vw; max-width: 300px; max-height: 300px; border-radius: 20px; margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #cover { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; transition: all 0.4s ease; }

        .menu-item {
            background: #3a3a3c;
            margin-bottom: 10px;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

    </style>
</head>
<body>

<header>M√∫sicas</header>

<div class="playlist-bar" id="playlistBar"></div>

<div class="controls-area">
    <div class="btn-main" onclick="triggerFileSelect()">Adicionar M√∫sicas</div>
    <div class="btn-row">
        <div class="btn-outline" onclick="openModal('playlist')">Nova Pasta</div>
        <label class="btn-outline">
            <input type="file" id="coverInput" accept="image/*" style="display:none">Capa
        </label>
        <div id="deleteFolderBtn" class="btn-outline" onclick="openModal('deleteFolder')" style="color:var(--danger); display:none">Apagar Pasta</div>
    </div>
</div>

<div id="library"></div>

<input type="file" id="fileInput" multiple accept="audio/*" style="display:none">

<div id="player" onclick="expandPlayer()">
    <div style="width: 35px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 0 auto 15px;"></div>
    
    <div id="mini-player-content" style="display:flex; align-items:center; gap:12px">
        <img id="cover" src="https://m.media-amazon.com/images/I/71aP14A5JgL._AC_UF894,1000_QL80_.jpg">
        <div style="flex:1; overflow:hidden" class="mini-only">
            <div id="title" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">Selecione uma m√∫sica</div>
            <div id="subtitle" style="font-size:12px; opacity:0.5">Artista</div>
        </div>
        <div class="mini-only" id="mini-play-btn" onclick="event.stopPropagation(); togglePlay()" style="font-size:24px; padding:5px 10px">‚ñ∂</div>
    </div>

    <div class="full-only" style="flex-direction:column; text-align:center; width:100%">
        <div id="full-info" style="margin-top:20px">
            <div id="full-title" style="font-size:22px; font-weight:700">---</div>
            <div id="full-subtitle" style="font-size:17px; opacity:0.6; margin-top:5px">---</div>
        </div>

        <div style="width:100%; margin-top:30px">
            <input type="range" id="progressSlider" value="0" step="0.1" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.5; margin-top:-10px">
                <span id="time-current">0:00</span>
                <span id="time-total">0:00</span>
            </div>
        </div>

        <div class="player-btns">
            <div onclick="event.stopPropagation(); prevSong()" style="font-size:30px">‚èÆ</div>
            <div onclick="event.stopPropagation(); togglePlay()" id="playBtn" class="play-circle">‚ñ∂</div>
            <div onclick="event.stopPropagation(); nextSong()" style="font-size:30px">‚è≠</div>
        </div>

        <div style="display:flex; align-items:center; gap:15px; margin-top:50px; padding:0 20px">
            <span style="opacity:0.4">üîà</span>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" onclick="event.stopPropagation()">
            <span style="opacity:0.4">üîä</span>
        </div>
    </div>
</div>

<div id="modalOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(15px); display:none; justify-content:center; align-items:center; z-index:5000">
    <div style="background:#2c2c2e; width:85%; max-height: 80vh; overflow-y: auto; padding:25px; border-radius:24px; text-align:center">
        <h3 id="modalTitle" style="margin-bottom:20px"></h3>
        <div id="modalBody"></div>
        <div id="modalFooter" style="display:flex; gap:10px; margin-top:20px">
            <button class="btn-outline" style="flex:1" onclick="closeModal()">Fechar</button>
            <button class="btn-main" id="modalConfirm" style="flex:1; display:none">Confirmar</button>
        </div>
    </div>
</div>

<audio id="audio"></audio>

<script>
    let db, allSongs = [], playlists = JSON.parse(localStorage.getItem('bs_playlists')) || [];
    let currentTab = 'Todas', currentSongId = null, isExpanded = false;
    const audio = document.getElementById("audio");

    const request = indexedDB.open("BluesoundDB", 10);
    request.onsuccess = (e) => { db = e.target.result; loadData(); };
    request.onupgradeneeded = (e) => {
        let database = e.target.result;
        if (!database.objectStoreNames.contains("songs")) database.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
    };

    function loadData() {
        const tx = db.transaction("songs", "readonly");
        tx.objectStore("songs").getAll().onsuccess = (e) => {
            allSongs = e.target.result;
            renderPlaylists();
            renderLibrary();
        };
    }

    function getActiveQueue() {
        return (currentTab === 'Todas') ? allSongs : allSongs.filter(s => s.playlist === currentTab);
    }

    function expandPlayer() {
        const p = document.getElementById("player");
        isExpanded = !isExpanded;
        p.classList.toggle("full", isExpanded);
    }

    function playSongById(id) {
        const song = allSongs.find(s => s.id === id);
        if (!song) return;
        currentSongId = id;
        const blob = new Blob([song.data], { type: "audio/mpeg" });
        if (audio.src) URL.revokeObjectURL(audio.src);
        audio.src = URL.createObjectURL(blob);
        document.getElementById("title").innerText = song.name;
        document.getElementById("full-title").innerText = song.name;
        document.getElementById("subtitle").innerText = song.playlist || "Geral";
        document.getElementById("full-subtitle").innerText = song.playlist || "Geral";
        document.getElementById("player").style.display = "flex";
        audio.play();
        updatePlayIcons(true);
        renderLibrary();
    }

    function togglePlay() {
        if (audio.paused) { audio.play(); updatePlayIcons(true); }
        else { audio.pause(); updatePlayIcons(false); }
    }

    function updatePlayIcons(isPlaying) {
        const icon = isPlaying ? "‚è∏" : "‚ñ∂";
        document.getElementById("playBtn").innerText = icon;
        document.getElementById("mini-play-btn").innerText = icon;
    }

    function nextSong() {
        const queue = getActiveQueue();
        const index = queue.findIndex(s => s.id === currentSongId);
        if (index !== -1 && index < queue.length - 1) playSongById(queue[index + 1].id);
        else if (queue.length > 0) playSongById(queue[0].id);
    }

    function prevSong() {
        const queue = getActiveQueue();
        const index = queue.findIndex(s => s.id === currentSongId);
        if (index > 0) playSongById(queue[index - 1].id);
        else if (queue.length > 0) playSongById(queue[queue.length - 1].id);
    }

    const progressSlider = document.getElementById("progressSlider");
    audio.ontimeupdate = () => {
        if (!isNaN(audio.duration)) {
            progressSlider.value = (audio.currentTime / audio.duration) * 100;
            document.getElementById("time-current").innerText = formatTime(audio.currentTime);
            document.getElementById("time-total").innerText = formatTime(audio.duration);
        }
    };
    progressSlider.oninput = () => { audio.currentTime = (progressSlider.value / 100) * audio.duration; };

    function formatTime(secs) {
        const min = Math.floor(secs / 60);
        const sec = Math.floor(secs % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function renderPlaylists() {
        const bar = document.getElementById("playlistBar");
        const deleteBtn = document.getElementById("deleteFolderBtn");
        
        bar.innerHTML = `<div class="playlist-chip ${currentTab === 'Todas' ? 'active' : ''}" onclick="switchTab('Todas')">Todas</div>`;
        playlists.forEach(p => bar.innerHTML += `<div class="playlist-chip ${currentTab === p ? 'active' : ''}" onclick="switchTab('${p}')">${p}</div>`);
        
        deleteBtn.style.display = (currentTab === 'Todas') ? 'none' : 'flex';
    }

    function switchTab(name) { currentTab = name; renderPlaylists(); renderLibrary(); }

    function renderLibrary() {
        const lib = document.getElementById("library");
        const filtered = getActiveQueue();
        lib.innerHTML = "";
        filtered.forEach((song) => {
            const div = document.createElement("div");
            div.className = "song";
            div.innerHTML = `
                <div style="flex:1" onclick="playSongById(${song.id})">
                    <div style="font-weight:600; ${currentSongId === song.id ? 'color:var(--accent)' : ''}">${song.name}</div>
                    <div style="font-size:12px; opacity:0.4">${song.playlist || 'Geral'}</div>
                </div>
                <div onclick="openModal('songOptions', ${song.id})" style="padding:10px; font-size:22px; opacity:0.6">‚ãÆ</div>
            `;
            lib.appendChild(div);
        });
    }

    function openModal(type, id = null) {
        const overlay = document.getElementById("modalOverlay");
        const title = document.getElementById("modalTitle");
        const body = document.getElementById("modalBody");
        const btn = document.getElementById("modalConfirm");
        overlay.style.display = "flex";
        btn.style.display = "none";
        
        if (type === 'songOptions') {
            title.innerText = "Mover m√∫sica";
            let pButtons = playlists.map(p => 
                `<div class="menu-item" onclick="moveToPlaylist(${id}, '${p}')">üìÇ ${p}</div>`
            ).join('');
            
            body.innerHTML = `
                ${pButtons}
                <hr style="opacity:0.1; margin:15px 0">
                <div class="menu-item" style="color:var(--danger); background:rgba(255,59,48,0.1)" onclick="deleteSong(${id})">üóëÔ∏è Excluir M√∫sica</div>
            `;
        } else if(type === 'playlist') {
            title.innerText = "Nova Pasta";
            body.innerHTML = `<input type="text" id="modalInput" style="width:100%; padding:15px; background:#1c1c1e; border:none; border-radius:12px; color:white; margin-top:10px; font-size:16px" placeholder="Nome da pasta">`;
            btn.style.display = "block";
            btn.onclick = () => {
                const name = document.getElementById("modalInput").value;
                if(name && name !== 'Todas') { 
                    playlists.push(name); 
                    localStorage.setItem('bs_playlists', JSON.stringify(playlists)); 
                    renderPlaylists(); 
                    closeModal(); 
                }
            }
        } else if(type === 'deleteFolder') {
            title.innerText = `Apagar Pasta?`;
            body.innerHTML = `Ao apagar "${currentTab}", as m√∫sicas voltar√£o para a lista principal.`;
            btn.style.display = "block";
            btn.style.background = "var(--danger)";
            btn.onclick = () => {
                const tx = db.transaction("songs", "readwrite");
                const store = tx.objectStore("songs");
                allSongs.forEach(song => {
                    if(song.playlist === currentTab) {
                        song.playlist = "";
                        store.put(song);
                    }
                });
                tx.oncomplete = () => {
                    playlists = playlists.filter(p => p !== currentTab);
                    localStorage.setItem('bs_playlists', JSON.stringify(playlists));
                    currentTab = 'Todas';
                    loadData();
                    closeModal();
                };
            }
        }
    }

    function closeModal() { 
        document.getElementById("modalOverlay").style.display = "none"; 
        document.getElementById("modalConfirm").style.background = "var(--accent)";
    }

    function triggerFileSelect() {
        document.getElementById("fileInput").click();
    }

    document.getElementById("fileInput").onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const tx = db.transaction("songs", "readwrite");
                tx.objectStore("songs").add({
                    name: file.name.replace(/\.[^/.]+$/, ""),
                    data: ev.target.result,
                    playlist: "" 
                });
                tx.oncomplete = loadData;
            };
            reader.readAsArrayBuffer(file);
        });
    };

    function moveToPlaylist(songId, playlistName) {
        const tx = db.transaction("songs", "readwrite");
        const store = tx.objectStore("songs");
        store.get(songId).onsuccess = (e) => {
            const song = e.target.result;
            song.playlist = playlistName;
            store.put(song);
        };
        tx.oncomplete = () => { loadData(); closeModal(); };
    }

    function deleteSong(id) {
        const tx = db.transaction("songs", "readwrite");
        tx.objectStore("songs").delete(id);
        tx.oncomplete = () => { loadData(); closeModal(); };
    }

    document.getElementById("coverInput").onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.querySelectorAll("#cover").forEach(img => img.src = ev.target.result);
                localStorage.setItem('playerCover', ev.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    if(localStorage.getItem('playerCover')) {
        document.querySelectorAll("#cover").forEach(img => img.src = localStorage.getItem('playerCover'));
    }
    
    document.getElementById("volumeSlider").oninput = (e) => audio.volume = e.target.value;
    audio.onended = () => nextSong();
</script>
</body>
</html>
