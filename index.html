<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BLUESOUND PRO</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #00d4ff;
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --accent: #007aff;
            --danger: #ff3b30;
            --ios-blur: rgba(30, 30, 30, 0.95);
            --ios-curve: cubic-bezier(0.32, 0.72, 0, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 140px;
            overflow-x: hidden;
            user-select: none;
            touch-action: pan-y;
            overscroll-behavior-x: none;
            transition: background 0.3s, color 0.3s;
        }

        [class^="ph-"] {
            font-size: 24px;
        }

        header {
            padding: 60px 20px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
            transition: background 0.3s;
        }

        .back-btn { color: var(--accent); font-size: 18px; display: none; align-items: center; gap: 5px; font-weight: 500; cursor: pointer; }
        .back-btn i { font-size: 26px; }
        
        header h1 { font-size: 34px; font-weight: 800; margin: 0; letter-spacing: -1px; color: var(--text); }
        .settings-icon { cursor: pointer; opacity: 0.8; color: var(--text); display: flex; align-items: center; }
        .settings-icon i { font-size: 28px; }

        .search-container { padding: 0 20px 10px; transition: opacity 0.3s; }
        .search-bar {
            width: 100%; background: rgba(150,150,150,0.2); border: none; padding: 12px 15px;
            border-radius: 12px; color: var(--text); font-size: 16px;
        }
        .search-bar::placeholder { color: var(--text); opacity: 0.5; }

        .view-container { display: flex; width: 400vw; transition: transform 0.6s var(--ios-curve); }
        .view { width: 100vw; padding: 0 20px; box-sizing: border-box; flex-shrink: 0; }

        .btn-main { background: var(--accent); color: white; padding: 16px; border-radius: 16px; text-align: center; font-weight: 600; flex: 1; margin-bottom: 15px; border:none; width: 100%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main i { font-size: 26px; }
        
        .btn-secondary { background: var(--card); color: var(--text); padding: 14px; border-radius: 12px; text-align: center; font-weight: 500; flex: 1; border:none; font-size: 14px; transition: background 0.3s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-secondary i { font-size: 22px; }

        .section-title { margin-top: 25px; opacity: 0.5; font-size: 13px; text-transform: uppercase; font-weight: 700; margin-left: 5px; color: var(--text); }

        #library, .folder-list, .settings-list { background: var(--card); border-radius: 18px; overflow: hidden; margin-top: 10px; transition: background 0.3s; }
        
        .song, .setting-item { padding: 16px 18px; display: flex; align-items: center; border-bottom: 0.5px solid rgba(150,150,150,0.1); transition: background 0.2s; gap: 10px; color: var(--text); cursor: pointer; }
        .song i, .setting-item i { font-size: 24px; }
        
        .song:active, .setting-item:active { background: rgba(150,150,150,0.1); }
        .song-name-wrapper { flex: 1; overflow: hidden; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        
        .marquee { display: inline-block; animation: marquee 10s linear infinite; padding-left: 20px; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        .song.active .song-name { color: var(--primary); }
        .song-name { font-size: 16px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 6px; }

        .list-wave { display: flex; align-items: flex-end; gap: 2px; width: 20px; height: 15px; margin-right: 5px; }
        .list-wave span { width: 3px; background: var(--primary); border-radius: 1px; animation: wave-anim 0.8s ease-in-out infinite alternate; }
        .list-wave span:nth-child(2) { animation-delay: 0.2s; }
        .list-wave span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes wave-anim { from { height: 3px; } to { height: 15px; } }

        .folder-item { padding: 22px 20px; display: flex; align-items: center; border-bottom: 0.5px solid rgba(150,150,150,0.1); color: var(--text); cursor: pointer; }
        .folder-item i { font-size: 24px; }

        #player {
            position: fixed; bottom: 30px; left: 15px; right: 15px;
            height: 64px; background: var(--ios-blur); backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px); border-radius: 24px; padding: 10px 15px;
            display: none; flex-direction: column; z-index: 2000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
            transition: all 0.6s var(--ios-curve);
            border: 0.5px solid rgba(255,255,255,0.1);
            overflow: hidden;
            color: var(--text);
        }
        
        #player.full { 
            bottom: 0; left: 0; right: 0; height: 100vh; border-radius: 0; 
            padding: 40px 30px; border: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 20px;
            background: var(--bg);
        }

        #cover { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.5s var(--ios-curve); }
        #player.full #cover { width: 80vw; height: 80vw; max-width: 320px; border-radius: 24px; margin: 0 auto; display: block; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .full-title-container { width: 100%; overflow: hidden; white-space: nowrap; text-align: center; height: 40px; margin-top: 10px; color: var(--text); }
        #full-title { font-size: 24px; font-weight: 700; display: inline-block; }

        #visualizer { display: none; height: 50px; width: 100%; align-items: center; justify-content: center; gap: 3px; margin: 10px 0; }
        #player.full #visualizer { display: flex; }
        .bar { width: 4px; height: 4px; background: var(--primary); border-radius: 2px; transition: height 0.05s ease; opacity: 0.7; }

        .player-controls-wrapper { width: 100%; color: var(--text); }
        .time-info { display: flex; justify-content: space-between; font-size: 13px; opacity: 0.5; margin-bottom: 10px; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { height: 6px; background: rgba(150,150,150,0.3); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 26px; width: 26px; background: var(--text); border-radius: 50%; margin-top: -10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }

        .controls-main { display: flex; justify-content: space-around; align-items: center; margin-top: 20px; color: var(--text); }
        .play-circle { width: 82px; height: 82px; background: var(--text); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--bg); box-shadow: 0 10px 25px rgba(0,0,0,0.2); cursor: pointer;}
        .play-circle i { font-size: 40px !important; }

        .extra-controls { display: flex; justify-content: center; gap: 40px; align-items: center; margin-top: 25px; color: var(--text); }
        .extra-controls i { font-size: 28px; }
        
        .control-toggle { opacity: 0.3; transition: 0.3s; cursor: pointer;}
        .control-toggle.active { opacity: 1; color: var(--primary); }
        
        #favBtn { transition: transform 0.2s var(--ios-curve); cursor: pointer; }
        #favBtn.active { color: #ff2d55; filter: drop-shadow(0 0 5px rgba(255,45,85,0.4)); }
        #favBtn:active { transform: scale(1.4); }

        .volume-area { display: flex; align-items: center; gap: 15px; padding: 0 10px; opacity: 0.8; margin-top: 30px; color: var(--text); }
        .volume-area i { font-size: 22px; }

        .color-picker-wrapper { display: flex; justify-content: space-between; align-items: center; width: 100%; color: var(--text); }
        .color-picker-wrapper input { border: none; width: 40px; height: 40px; cursor: pointer; background: none; }

        #modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(25px); display:none; justify-content:center; align-items:center; z-index:10000; padding: 20px; }
        .modal-content { background: var(--card); width:100%; max-width: 400px; max-height: 90vh; padding:30px; border-radius:32px; overflow-y: auto; border: 0.5px solid rgba(150,150,150,0.2); box-shadow: 0 30px 60px rgba(0,0,0,0.6); transition: all 0.4s var(--ios-curve); transform: scale(0.8); opacity: 0; color: var(--text); }
        #modalOverlay.active { display: flex; }
        #modalOverlay.active .modal-content { transform: scale(1); opacity: 1; }

        .menu-item { background: rgba(150,150,150,0.1); margin-bottom: 12px; padding: 20px; border-radius: 18px; font-weight: 600; text-align: center; color: var(--text); transition: background 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .menu-item i { font-size: 24px; }

        #toast { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 12px 28px; border-radius: 25px; font-weight: 800; z-index: 9999; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); align-items: center; gap: 8px; }
        #toast i { font-size: 20px; }

        .theme-switch-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }

        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg); z-index: 9998; display: none; align-items: center;
            justify-content: center; padding: 40px 30px; transition: all 0.5s var(--ios-curve);
        }
        .welcome-content { max-width: 400px; height: 100%; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .welcome-icon { font-size: 80px; margin: 60px 0 30px; animation: welcomePulse 2s infinite ease-in-out; filter: drop-shadow(0 0 20px var(--primary)); }
        .welcome-features { text-align: left; width: 100%; margin-bottom: 30px; }
        .feat { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; font-weight: 500; }
        .feat i { font-size: 24px; }
        .legal-link { color: var(--primary); text-decoration: underline; cursor: pointer; }
        
        @keyframes welcomePulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .info-card { padding: 20px; opacity: 0.6; text-align: center; font-size: 13px; }

        #mini-play-btn i { font-size: 30px; }
    </style>
</head>
<body>

<div id="welcomeScreen">
    <div class="welcome-content">
        <div class="welcome-icon"><i class="ph-bold ph-music-notes" style="font-size: 80px;"></i></div>
        <h2 style="font-size: 32px; font-weight: 800; margin-bottom: 10px;">Bem-vindo ao<br>BLUESOUND PRO</h2>
        <p style="opacity: 0.6; line-height: 1.5; margin-bottom: 40px;">Sua biblioteca musical offline com interface premium e som de alta fidelidade.</p>
        
        <div class="welcome-features">
            <div class="feat"><i class="ph-bold ph-folder"></i> Organização por pastas</div>
            <div class="feat"><i class="ph-bold ph-palette"></i> Temas customizáveis</div>
            <div class="feat"><i class="ph-bold ph-lightning"></i> Performance nativa</div>
        </div>

        <div style="margin-top: auto; width: 100%;">
            <p style="font-size: 12px; opacity: 0.5; margin-bottom: 20px; text-align: center;">
                Antes de começar, leia nossos <br>
                <span class="legal-link" onclick="openLegal('terms')">Termos de Serviço</span> e 
                <span class="legal-link" onclick="openLegal('privacy')">Política de Privacidade</span>.
            </p>
            <button class="btn-main" onclick="dismissWelcome()" style="height: 60px; font-size: 18px;">Começar Agora</button>
        </div>
    </div>
</div>

<div id="toast">Pronto!</div>

<header id="appHeader">
    <div class="back-btn" id="backBtn" onclick="goBack()"><i class="ph-bold ph-caret-left"></i> Voltar</div>
    <h1 id="mainTitle">Músicas</h1>
    <div class="settings-icon" id="settingsBtn" onclick="goToSettings()"><i class="ph-bold ph-gear"></i></div>
</header>

<div class="search-container" id="searchWrap">
    <input type="text" class="search-bar" id="searchInput" placeholder="Procurar música...">
</div>

<div class="view-container" id="viewContainer">
    <div class="view" id="viewMain">
        <button class="btn-main" onclick="goToFolders()"><i class="ph-bold ph-folder"></i> Ver Pastas</button>
        <div style="display:flex; gap:10px">
            <button class="btn-secondary" onclick="triggerFileSelect()"><i class="ph-bold ph-download-simple"></i> Importar</button>
            <label class="btn-secondary">
                <input type="file" id="coverInput" accept="image/*" style="display:none"><i class="ph-bold ph-image"></i> Mudar Capa
            </label>
        </div>
        <div class="section-title">Biblioteca Geral</div>
        <div id="library"></div>
    </div>

    <div class="view" id="viewFolderContent">
        <div id="folderListContainer">
            <button class="btn-main" onclick="openModal('playlist')"><i class="ph-bold ph-folder-plus"></i> Nova Pasta</button>
            <div id="folderList" class="folder-list"></div>
        </div>
        <div id="folderSongsContainer" style="display:none">
            <button id="delFolderBtn" class="btn-secondary" style="background:var(--danger); width:100%; margin-bottom: 20px; height: 55px; border-radius: 16px; color: white;" onclick="openModal('deleteFolder')"><i class="ph-bold ph-trash"></i> Apagar Pasta</button>
            <div id="folderLibrary" class="folder-list"></div>
        </div>
    </div>

    <div class="view" id="viewSettings">
        <div class="section-title">Temas Rápidos</div>
        <div class="theme-switch-row">
            <button class="btn-secondary" onclick="quickTheme('dark')"><i class="ph-bold ph-moon"></i> Escuro</button>
            <button class="btn-secondary" onclick="quickTheme('light')"><i class="ph-bold ph-sun"></i> Claro</button>
        </div>
        <div class="section-title">Preferências</div>
        <div class="settings-list">
            <div class="setting-item" onclick="goToColors()">
                <i class="ph-bold ph-palette"></i>
                <span style="flex:1">Personalizar Cores</span>
                <i class="ph-bold ph-caret-right"></i>
            </div>
        </div>
        <div class="info-card">
            <div style="font-weight: 800; font-size: 16px; margin-bottom: 5px; color: var(--text); opacity: 1;">BLUESOUND PRO</div>
            <div>Versão 2.4.0</div>
            <div style="margin-top: 10px;">Criado por <span style="color: var(--primary); font-weight: 600;">THDEVZI</span></div>
        </div>
    </div>

    <div class="view" id="viewColors">
        <div class="section-title">Escolha suas cores</div>
        <div class="settings-list" id="colorControls">
            <div class="setting-item">
                <div class="color-picker-wrapper">
                    <span>Cor Principal</span>
                    <input type="color" id="color-primary" oninput="updateTheme('primary', this.value)">
                </div>
            </div>
            <div class="setting-item">
                <div class="color-picker-wrapper">
                    <span>Fundo (Background)</span>
                    <input type="color" id="color-bg" oninput="updateTheme('bg', this.value)">
                </div>
            </div>
            <div class="setting-item">
                <div class="color-picker-wrapper">
                    <span>Blocos (Cards)</span>
                    <input type="color" id="color-card" oninput="updateTheme('card', this.value)">
                </div>
            </div>
            <div class="setting-item">
                <div class="color-picker-wrapper">
                    <span>Texto</span>
                    <input type="color" id="color-text" oninput="updateTheme('text', this.value)">
                </div>
            </div>
            <div class="setting-item">
                <div class="color-picker-wrapper">
                    <span>Botões</span>
                    <input type="color" id="color-accent" oninput="updateTheme('accent', this.value)">
                </div>
            </div>
        </div>
        <button class="btn-secondary" style="margin-top: 20px; width:100%; color:var(--danger)" onclick="restoreDefaultColors()">Restaurar Cores Padrão</button>
    </div>
</div>

<input type="file" id="fileInput" multiple accept=".mp3, .wav, .m4a, .ogg" style="display:none">

<div id="player" onclick="expandPlayer()">
    <div id="drag-indicator" style="width: 36px; height: 5px; background: rgba(150,150,150,0.3); border-radius: 10px; margin: 0 auto 10px;"></div>
    <div style="display:flex; align-items:center; gap:12px; width: 100%;" id="mini-player-content">
        <img id="cover" src="https://raw.githubusercontent.com/THDEVZI/BLUESOUND/refs/heads/main/icon.png">
        <div style="flex:1; overflow:hidden" class="mini-only">
            <div id="title" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">Selecione uma música</div>
        </div>
        <div class="mini-only" id="mini-play-btn" onclick="event.stopPropagation(); togglePlay()"><i class="ph-fill ph-play"></i></div>
    </div>
    <div id="fullPlayerUI" style="display:none; flex:1; flex-direction:column; width:100%;">
        <div class="full-title-container"><div id="full-title">---</div></div>
        <div id="visualizer"></div>
        <div class="player-controls-wrapper">
            <div class="time-info"><span id="time-current">0:00</span><span id="time-total">0:00</span></div>
            <input type="range" id="progressSlider" value="0" step="0.1" onclick="event.stopPropagation()">
            <div class="controls-main">
                <div onclick="event.stopPropagation(); prevSong()" style="cursor: pointer;"><i class="ph-fill ph-skip-back" style="font-size: 38px;"></i></div>
                <div onclick="event.stopPropagation(); togglePlay()" id="playBtn" class="play-circle"><i class="ph-fill ph-play"></i></div>
                <div onclick="event.stopPropagation(); nextSong()" style="cursor: pointer;"><i class="ph-fill ph-skip-forward" style="font-size: 38px;"></i></div>
            </div>
            <div class="extra-controls">
                <div id="shuffleBtn" class="control-toggle" onclick="event.stopPropagation(); toggleShuffle()"><i class="ph-bold ph-shuffle"></i></div>
                <div id="favBtn" onclick="event.stopPropagation(); toggleFavorite()"><i class="ph-bold ph-heart"></i></div>
                <div id="repeatBtn" class="control-toggle" onclick="event.stopPropagation(); toggleRepeat()"><i class="ph-bold ph-repeat"></i></div>
            </div>
            <div class="volume-area" id="volumeArea">
                <i class="ph-bold ph-speaker-low"></i><input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" onclick="event.stopPropagation()"><i class="ph-bold ph-speaker-high"></i>
            </div>
        </div>
    </div>
</div>

<div id="modalOverlay" onclick="closeModal()">
    <div class="modal-content" id="modalContent" onclick="event.stopPropagation()">
        <h3 id="modalTitle" style="text-align:center; margin-bottom:20px; font-size: 22px;"></h3>
        <div id="modalBody"></div>
        <div style="display:flex; gap:12px; margin-top:25px" id="modalButtons">
            <button class="btn-secondary" style="flex:1; background: rgba(150,150,150,0.1);" onclick="closeModal()">Cancelar</button>
            <button id="modalConfirm" class="btn-main" style="flex:1; display:none; margin-bottom:0">Confirmar</button>
        </div>
    </div>
</div>

<audio id="audio" crossorigin="anonymous"></audio>

<script>
    let db, allSongs = [], playlists = JSON.parse(localStorage.getItem('bs_playlists')) || [];
    let currentPlaylist = null, currentSongId = null, isExpanded = false;
    let isShuffle = false, isRepeat = false;
    let searchTimer;
    const audio = document.getElementById("audio");

    audio.volume = localStorage.getItem('bs_volume') || 1;
    document.getElementById('volumeSlider').value = audio.volume;

    if (playlists.length === 0) {
        playlists.push("Favoritos");
        localStorage.setItem('bs_playlists', JSON.stringify(playlists));
    }

    let audioCtx, analyser, source, dataArray, barsElements = [];

    const defaultTheme = {
        primary: '#00d4ff',
        bg: '#000000',
        card: '#1c1c1e',
        text: '#ffffff',
        accent: '#007aff'
    };

    const request = indexedDB.open("BluesoundDB", 14);
    request.onsuccess = (e) => { 
        db = e.target.result; 
        loadData(); 
        applySavedTheme(); 
        checkFirstVisit();
        const lastId = localStorage.getItem('bs_last_song');
        if(lastId) {
            setTimeout(() => {
                const song = allSongs.find(s => s.id == lastId);
                if(song) {
                   updatePlayerUI(song.name);
                   document.getElementById("player").style.display = "flex";
                   setupMediaSession(song);
                }
            }, 500);
        }
    };
    request.onupgradeneeded = (e) => {
        let database = e.target.result;
        if (!database.objectStoreNames.contains("songs")) database.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
    };

    function checkFirstVisit() {
        if (!localStorage.getItem('bs_visited')) {
            const ws = document.getElementById('welcomeScreen');
            ws.style.display = 'flex';
            setTimeout(() => { ws.style.opacity = '1'; }, 50);
        }
    }

    function dismissWelcome() {
        const ws = document.getElementById('welcomeScreen');
        ws.style.opacity = '0';
        ws.style.transform = 'scale(1.1)';
        setTimeout(() => {
            ws.style.display = 'none';
            localStorage.setItem('bs_visited', 'true');
        }, 500);
    }

    function openLegal(type) {
        const title = type === 'terms' ? "Termos de Serviço" : "Política de Privacidade";
        const content = type === 'terms' 
            ? "O BLUESOUND PRO é um reprodutor offline. Ao importar músicas, você garante que possui os direitos legais sobre os arquivos. Não armazenamos seus dados em nuvem."
            : "Sua privacidade é nossa prioridade. Todo o processamento de áudio, temas e lista de reprodução ocorre exclusivamente no seu dispositivo (IndexDB).";
        
        openModal('legalText');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerHTML = `<p style="opacity:0.7; line-height:1.6; text-align:center">${content}</p>`;
    }

    function loadData() {
        if(!db) return;
        const tx = db.transaction("songs", "readonly");
        tx.objectStore("songs").getAll().onsuccess = (e) => {
            allSongs = e.target.result;
            renderMainLibrary();
            renderFolders();
            if (currentPlaylist) renderFolderSongs(currentPlaylist);
            updateFavIcon();
        };
    }

    document.getElementById("searchInput").oninput = (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => { renderMainLibrary(); }, 200);
    };

    function focusInput(id) {
        const el = document.getElementById(id);
        if (el) { el.focus(); setTimeout(() => { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300); }
    }

    function setupMediaSession(song) {
        if ('mediaSession' in navigator) {
            const currentCover = localStorage.getItem('playerCover') || 'https://raw.githubusercontent.com/THDEVZI/BLUESOUND/refs/heads/main/icon.png';
            navigator.mediaSession.metadata = new MediaMetadata({
                title: song.name, artist: 'Bluesound Pro', artwork: [{ src: currentCover, sizes: '512x512', type: 'image/png' }]
            });
            navigator.mediaSession.setActionHandler('play', () => togglePlay());
            navigator.mediaSession.setActionHandler('pause', () => togglePlay());
            navigator.mediaSession.setActionHandler('previoustrack', () => prevSong());
            navigator.mediaSession.setActionHandler('nexttrack', () => nextSong());
        }
    }

    function syncPlaybackState() { if ('mediaSession' in navigator) navigator.mediaSession.playbackState = audio.paused ? "paused" : "playing"; }

    function goToFolders() {
        document.getElementById("viewContainer").style.transform = "translateX(-100vw)";
        document.getElementById("backBtn").style.display = "flex";
        document.getElementById("settingsBtn").style.display = "none";
        document.getElementById("mainTitle").innerText = "Pastas";
        document.getElementById("searchWrap").style.opacity = "0";
        setTimeout(() => { document.getElementById("searchWrap").style.display = "none"; }, 300);
    }

    function goToSettings() {
        document.getElementById("viewContainer").style.transform = "translateX(-200vw)";
        document.getElementById("backBtn").style.display = "flex";
        document.getElementById("settingsBtn").style.display = "none";
        document.getElementById("mainTitle").innerText = "Ajustes";
        document.getElementById("searchWrap").style.opacity = "0";
        setTimeout(() => { document.getElementById("searchWrap").style.display = "none"; }, 300);
    }

    function goToColors() { document.getElementById("viewContainer").style.transform = "translateX(-300vw)"; document.getElementById("mainTitle").innerText = "Cores"; }

    function goBack() {
        const container = document.getElementById("viewContainer");
        const transform = container.style.transform;
        if (transform === "translateX(-300vw)") { goToSettings(); } 
        else if (currentPlaylist) {
            currentPlaylist = null;
            document.getElementById("mainTitle").innerText = "Pastas";
            document.getElementById("folderListContainer").style.display = "block";
            document.getElementById("folderSongsContainer").style.display = "none";
        } else {
            container.style.transform = "translateX(0)";
            document.getElementById("backBtn").style.display = "none";
            document.getElementById("settingsBtn").style.display = "block";
            document.getElementById("mainTitle").innerText = "Músicas";
            document.getElementById("searchWrap").style.display = "block";
            setTimeout(() => { document.getElementById("searchWrap").style.opacity = "1"; }, 50);
        }
    }

    function updateTheme(prop, value) {
        document.documentElement.style.setProperty('--' + prop, value);
        if(prop === 'bg') document.getElementById('appHeader').style.background = value;
        let currentTheme = JSON.parse(localStorage.getItem('bs_theme')) || {...defaultTheme};
        currentTheme[prop] = value;
        localStorage.setItem('bs_theme', JSON.stringify(currentTheme));
        const input = document.getElementById('color-' + prop);
        if(input) input.value = value;
    }

    function applySavedTheme() {
        const theme = JSON.parse(localStorage.getItem('bs_theme')) || defaultTheme;
        for (let prop in theme) { updateTheme(prop, theme[prop]); }
    }

    function quickTheme(mode) {
        if(mode === 'dark') { updateTheme('bg', '#000000'); updateTheme('card', '#1c1c1e'); updateTheme('text', '#ffffff'); } 
        else { updateTheme('bg', '#f2f2f7'); updateTheme('card', '#ffffff'); updateTheme('text', '#000000'); }
        showToast("Tema aplicado");
    }

    function restoreDefaultColors() { openModal('confirmResetThemes'); }

    function toggleFavorite() {
        if (!currentSongId) return;
        const song = allSongs.find(s => s.id === currentSongId);
        if (!song) return;
        if (!song.playlists) song.playlists = [];
        const favIndex = song.playlists.indexOf("Favoritos");
        if (favIndex > -1) { song.playlists.splice(favIndex, 1); showToast("Removido dos Favoritos"); } 
        else { song.playlists.push("Favoritos"); showToast("Adicionado aos Favoritos", "ph-fill ph-heart"); }
        const tx = db.transaction("songs", "readwrite");
        tx.objectStore("songs").put(song);
        tx.oncomplete = () => loadData();
    }

    function updateFavIcon() {
        const favBtn = document.getElementById("favBtn");
        if (!favBtn) return;
        if (!currentSongId) { favBtn.style.display = "none"; return; }
        favBtn.style.display = "block";
        const song = allSongs.find(s => s.id === currentSongId);
        const isFav = song && song.playlists && song.playlists.includes("Favoritos");
        favBtn.innerHTML = `<i class="${isFav ? 'ph-fill' : 'ph-bold'} ph-heart"></i>`;
        favBtn.classList.toggle("active", isFav);
    }

    function initVisualizer() {
        if (audioCtx) return;
        try {
            const container = document.getElementById('visualizer');
            for (let i = 0; i < 25; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                container.appendChild(bar);
                barsElements.push(bar);
            }
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.fftSize = 64;
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            renderFrame();
        } catch(e) {}
    }

    function renderFrame() {
        requestAnimationFrame(renderFrame);
        if (!analyser) return;
        analyser.getByteFrequencyData(dataArray);
        barsElements.forEach((bar, i) => {
            const val = dataArray[i] || 0;
            const height = (val / 255) * 50;
            bar.style.height = Math.max(4, height) + "px";
            bar.style.opacity = 0.4 + (height / 50);
        });
    }

    function getQueue() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        if (term && !currentPlaylist) return allSongs.filter(s => s.name.toLowerCase().includes(term));
        if (currentPlaylist) return allSongs.filter(s => s.playlists && s.playlists.includes(currentPlaylist));
        return allSongs;
    }

    function openFolder(n) {
        currentPlaylist = n; document.getElementById("mainTitle").innerText = n;
        document.getElementById("folderListContainer").style.display = "none";
        document.getElementById("folderSongsContainer").style.display = "block";
        document.getElementById("delFolderBtn").style.display = (n === "Favoritos") ? "none" : "block";
        renderFolderSongs(n);
    }

    function openModal(type, id = null, inFolder = false) {
        const overlay = document.getElementById("modalOverlay");
        const body = document.getElementById("modalBody");
        const confirmBtn = document.getElementById("modalConfirm");
        const title = document.getElementById("modalTitle");
        
        overlay.classList.add("active");
        confirmBtn.style.display = "none";
        confirmBtn.style.background = "var(--accent)";
        body.innerHTML = "";

        if (type === 'options') {
            title.innerText = "Opções";
            body.innerHTML = `
                <div class="menu-item" onclick="openModal('rename', ${id})"><i class="ph-bold ph-pencil-simple"></i> Renomear</div>
                <div class="menu-item" onclick="openModal('addToFolder', ${id})"><i class="ph-bold ph-folder-plus"></i> Adicionar à Pasta</div>
                ${inFolder ? `<div class="menu-item" style="color:var(--primary)" onclick="removeFromPlaylist(${id}, '${currentPlaylist}')"><i class="ph-bold ph-folder-minus"></i> Remover desta Pasta</div>` : ''}
                <hr style="opacity:0.1; margin:15px 0">
                <div class="menu-item" style="color:var(--danger)" onclick="openModal('confirmDeleteSong', ${id})"><i class="ph-bold ph-trash"></i> Excluir Arquivo</div>`;
        } else if (type === 'rename') {
            title.innerText = "Renomear";
            const song = allSongs.find(s => s.id === id);
            body.innerHTML = `<input type="text" id="renameInput" class="search-bar" value="${song.name}">`;
            confirmBtn.style.display = "block"; confirmBtn.innerText = "Salvar";
            confirmBtn.onclick = () => { const newName = document.getElementById("renameInput").value; if(newName) { renameSong(id, newName); closeModal(); } };
            setTimeout(() => focusInput('renameInput'), 100);
        } else if (type === 'confirmDeleteSong') {
            title.innerText = "Excluir Música?";
            body.innerHTML = "<p style='text-align:center; opacity:0.7'>Isso apagará o arquivo permanentemente da biblioteca.</p>";
            confirmBtn.style.display = "block"; confirmBtn.innerText = "Excluir"; confirmBtn.style.background = "var(--danger)";
            confirmBtn.onclick = () => { del(id); closeModal(); };
        } else if (type === 'deleteFolder') {
            title.innerText = "Apagar Pasta?";
            body.innerHTML = `<p style='text-align:center; opacity:0.7'>Deseja apagar a pasta <b>${currentPlaylist}</b>? As músicas continuarão na biblioteca geral.</p>`;
            confirmBtn.style.display = "block"; confirmBtn.innerText = "Apagar"; confirmBtn.style.background = "var(--danger)";
            confirmBtn.onclick = () => { 
                playlists = playlists.filter(p => p !== currentPlaylist);
                localStorage.setItem('bs_playlists', JSON.stringify(playlists));
                allSongs.forEach(s => {
                    if(s.playlists && s.playlists.includes(currentPlaylist)) {
                        s.playlists = s.playlists.filter(x => x !== currentPlaylist);
                        const tx = db.transaction("songs", "readwrite");
                        tx.objectStore("songs").put(s);
                    }
                });
                showToast("Pasta removida");
                goBack();
                renderFolders();
                closeModal();
            };
        } else if (type === 'addToFolder') {
            title.innerText = "Escolher Pasta";
            body.innerHTML = `<input type="text" id="fSearch" class="search-bar" placeholder="Buscar..." style="margin-bottom:15px"> <div id="fList"></div>`;
            const draw = (f="") => { document.getElementById("fList").innerHTML = playlists.filter(p => p.toLowerCase().includes(f.toLowerCase())).map(p => `<div class="menu-item" onclick="addToPlaylist(${id}, '${p}')">${p}</div>`).join(""); };
            draw();
            document.getElementById("fSearch").oninput = (e) => draw(e.target.value);
            setTimeout(() => focusInput('fSearch'), 100);
        } else if (type === 'playlist') {
            title.innerText = "Nova Pasta";
            body.innerHTML = `<input type="text" id="mInput" class="search-bar" placeholder="Nome da pasta">`;
            confirmBtn.style.display = "block"; confirmBtn.innerText = "Criar";
            confirmBtn.onclick = () => { const v = document.getElementById("mInput").value; if(v && !playlists.includes(v)){ playlists.push(v); localStorage.setItem('bs_playlists', JSON.stringify(playlists)); renderFolders(); closeModal(); } };
            setTimeout(() => focusInput('mInput'), 100);
        } else if (type === 'confirmResetThemes') {
            title.innerText = "Restaurar Cores?";
            body.innerHTML = "<p style='text-align:center; opacity:0.7'>Deseja voltar para as cores originais?</p>";
            confirmBtn.style.display = "block"; confirmBtn.innerText = "Sim";
            confirmBtn.onclick = () => { localStorage.removeItem('bs_theme'); applySavedTheme(); closeModal(); showToast("Restaurado!"); };
        }
    }

    function closeModal() { document.getElementById("modalOverlay").classList.remove("active"); }

    audio.onended = () => { if (isRepeat) { audio.currentTime = 0; audio.play(); } else { nextSong(); } };

    function nextSong() {
        const q = getQueue(); if (q.length <= 1) return;
        let i = q.findIndex(s => s.id === currentSongId);
        if (isShuffle) {
            let nextIdx; do { nextIdx = Math.floor(Math.random() * q.length); } while (nextIdx === i && q.length > 1);
            playSongById(q[nextIdx].id);
        } else { playSongById(q[(i + 1) % q.length].id); }
    }

    function prevSong() {
        const q = getQueue(); if (q.length <= 1) return;
        let i = q.findIndex(s => s.id === currentSongId);
        playSongById(q[(i - 1 + q.length) % q.length].id);
    }

    function toggleShuffle() { isShuffle = !isShuffle; document.getElementById("shuffleBtn").classList.toggle("active", isShuffle); }
    function toggleRepeat() { isRepeat = !isRepeat; document.getElementById("repeatBtn").classList.toggle("active", isRepeat); }
    
    function togglePlay() { 
        if(audio.src) {
            if(audio.paused) { audio.play(); initVisualizer(); } else { audio.pause(); } 
            updatePlayIcons(!audio.paused);
        }
    }

    function updatePlayIcons(p) { 
        const iconName = p ? 'pause' : 'play';
        document.getElementById("playBtn").innerHTML = `<i class="ph-fill ph-${iconName}"></i>`; 
        document.getElementById("mini-play-btn").innerHTML = `<i class="ph-fill ph-${iconName}"></i>`; 
        syncPlaybackState(); renderMainLibrary(); 
        if (currentPlaylist) renderFolderSongs(currentPlaylist);
    }
    
    function playSongById(id) {
        const song = allSongs.find(s => s.id === id); if (!song) return;
        if (audio.src) URL.revokeObjectURL(audio.src);
        currentSongId = id; localStorage.setItem('bs_last_song', id);
        const blob = new Blob([song.data], { type: 'audio/mpeg' });
        audio.src = URL.createObjectURL(blob);
        updatePlayerUI(song.name); updateFavIcon(); setupMediaSession(song);
        document.getElementById("player").style.display = "flex";
        audio.play().then(() => { initVisualizer(); updatePlayIcons(true); }).catch(e => {});
    }

    function updatePlayerUI(name) {
        document.getElementById("title").innerText = name;
        const fullTitle = document.getElementById("full-title");
        if (name.length > 20) { fullTitle.innerHTML = `<div class="marquee">${name} &nbsp;&nbsp;&nbsp; ${name}</div>`; } 
        else { fullTitle.innerText = name; }
    }

    function expandPlayer() {
        isExpanded = !isExpanded; document.getElementById("player").classList.toggle("full", isExpanded);
        document.getElementById("fullPlayerUI").style.display = isExpanded ? "flex" : "none";
        document.querySelectorAll(".mini-only").forEach(el => el.style.display = isExpanded ? "none" : "block");
        document.body.style.overflow = isExpanded ? "hidden" : "auto";
    }

    function renderMainLibrary() {
        const lib = document.getElementById("library"); if(!lib) return;
        const term = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allSongs.filter(s => s.name.toLowerCase().includes(term));
        lib.innerHTML = filtered.length ? "" : "<p style='padding:20px; opacity:0.3'>Vazio</p>";
        filtered.forEach(s => lib.appendChild(createSongEl(s, false)));
    }

    function createSongEl(song, inFolder) {
        const div = document.createElement("div");
        const isActive = currentSongId === song.id, isPlaying = !audio.paused;
        div.className = `song ${isActive ? 'active' : ''}`;
        
        const nameHtml = song.name.length > 25 ? `<div class="marquee">${song.name} &nbsp;&nbsp;&nbsp; ${song.name}</div>` : `<span>${song.name}</span>`;
        const waveHtml = (isActive && isPlaying) ? `<div class="list-wave"><span></span><span></span><span></span></div>` : '';
        const pauseIcon = (isActive && !isPlaying) ? `<i class="ph-fill ph-pause-circle" style="color:var(--primary); font-size:18px;"></i>` : '';

        div.innerHTML = `
            ${waveHtml}
            <div class="song-name-wrapper" onclick="playSongById(${song.id})">
                <div class="song-name">${pauseIcon} ${nameHtml}</div>
            </div>
            <div onclick="openModal('options', ${song.id}, ${inFolder})" style="padding:10px; opacity:0.4; display:flex; align-items:center;"><i class="ph-bold ph-dots-three-vertical"></i></div>`;
        return div;
    }

    function renderFolders() {
        const folderList = document.getElementById("folderList"); if(!folderList) return;
        folderList.innerHTML = playlists.map(p => {
            const icon = p === 'Favoritos' ? 'heart' : 'folder';
            return `<div class="folder-item" onclick="openFolder('${p}')"><i class="ph-bold ph-${icon}" style="margin-right:12px"></i> <span style="flex:1">${p}</span><i class="ph-bold ph-caret-right"></i></div>`
        }).join("");
    }

    function renderFolderSongs(n) {
        const lib = document.getElementById("folderLibrary"); if(!lib) return;
        const songs = allSongs.filter(s => s.playlists && s.playlists.includes(n));
        lib.innerHTML = songs.length ? "" : "<p style='padding:20px; opacity:0.3'>Vazio</p>";
        songs.forEach(s => lib.appendChild(createSongEl(s, true)));
    }

    function showToast(m, iconClass = "ph-bold ph-check-circle") { 
        const t = document.getElementById("toast"); 
        t.innerHTML = `<i class="${iconClass}"></i> <span>${m}</span>`;
        t.style.display = "flex"; 
        setTimeout(()=>t.style.display="none", 2000); 
    }

    audio.ontimeupdate = () => {
        if(!audio.duration) return;
        const progress = (audio.currentTime / audio.duration) * 100;
        document.getElementById("progressSlider").value = progress;
        const f = (s) => Math.floor(s/60) + ":" + Math.floor(s%60).toString().padStart(2,'0');
        document.getElementById("time-current").innerText = f(audio.currentTime);
        document.getElementById("time-total").innerText = f(audio.duration);
    };

    document.getElementById("progressSlider").oninput = (e) => { if(audio.duration) audio.currentTime = (e.target.value/100) * audio.duration; };
    document.getElementById("volumeSlider").oninput = (e) => { audio.volume = e.target.value; localStorage.setItem('bs_volume', e.target.value); };

    function triggerFileSelect() { document.getElementById("fileInput").click(); }
    
    document.getElementById("fileInput").onchange = async (e) => {
        const files = Array.from(e.target.files); if(!files.length) return;
        showToast(`Importando...`, "ph-bold ph-download-simple");
        for (const file of files) {
            await new Promise((r) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const tx = db.transaction("songs", "readwrite");
                    tx.objectStore("songs").add({ name: file.name.replace(/\.[^/.]+$/, ""), data: ev.target.result, playlists: [] });
                    tx.oncomplete = r;
                };
                reader.readAsArrayBuffer(file);
            });
        }
        loadData(); showToast("Concluído!");
    };

    document.getElementById("coverInput").onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => { 
            document.querySelectorAll("#cover").forEach(img => img.src = ev.target.result); 
            localStorage.setItem('playerCover', ev.target.result);
            const currentSong = allSongs.find(s => s.id === currentSongId);
            if(currentSong) setupMediaSession(currentSong);
        };
        r.readAsDataURL(e.target.files[0]);
    };

    function addToPlaylist(id, p) {
        const tx = db.transaction("songs", "readwrite");
        const store = tx.objectStore("songs");
        store.get(id).onsuccess = (e) => {
            const s = e.target.result; if(!s.playlists) s.playlists = [];
            if(!s.playlists.includes(p)) { s.playlists.push(p); store.put(s); showToast("Adicionado!"); } else { showToast("Já está na pasta", "ph-bold ph-warning"); }
        };
        tx.oncomplete = () => { loadData(); closeModal(); };
    }

    function removeFromPlaylist(id, p) {
        const tx = db.transaction("songs", "readwrite");
        const store = tx.objectStore("songs");
        store.get(id).onsuccess = (e) => { const s = e.target.result; s.playlists = s.playlists.filter(x => x !== p); store.put(s); };
        tx.oncomplete = () => { loadData(); closeModal(); showToast("Removido"); };
    }

    function renameSong(id, newName) {
        const tx = db.transaction("songs", "readwrite");
        const store = tx.objectStore("songs");
        store.get(id).onsuccess = (e) => { const s = e.target.result; s.name = newName; store.put(s); };
        tx.oncomplete = () => { loadData(); if(currentSongId === id) updatePlayerUI(newName); showToast("Renomeado!"); };
    }

    function del(id) {
        const tx = db.transaction("songs", "readwrite");
        tx.objectStore("songs").delete(id);
        tx.oncomplete = () => { 
            loadData(); if(currentSongId === id) { audio.pause(); audio.src = ""; document.getElementById("player").style.display = "none"; }
            showToast("Excluída"); 
        };
    }
</script>
</body>
</html>
